# BMS_predict_by_CNN
# 畳み込みニューラルネットワークを用いた黒毛和種枝肉断面画像のBMS判定

スクリプトはすべてPython3で記述しています。

Keras (TensorFlow), numpy, pandas, matplotlib, sklearn, PIL 等のパッケージを利用します。

Anaconda3 をインストールすれば、Keras (TensorFlow) 以外はデフォルトでインストールされると思います。


## 枝肉断面画像からのロース芯画像の切り出し

枝肉断面画像のロース芯中央座標を予測し、ロース芯を中心とした正方形の画像を切り出す。

Pythonスクリプトを任意のフォルダに置き、直下のフォルダに枝肉断面画像をまとめて入れておきます。

### データセットの作成

　ロース芯中央座標が明らかな画像リストのcsvファイルを作成してください。

　3カラムで、1行目のカラム名をimgpath, x, yとし、それぞれに「枝肉断面画像のパス」，「X座標の数値」，「Y座標の数値」を入力したcsvファイルにしてください。

　loincenter_makedata_for_train.py に画像リストCSVファイルのパスを指定し、実行してください。

　学習用の画像データセットファイルと、座標データセットファイル（.npy）が作成されます。

### ロース芯中心座標の学習

　loincenter_train.py の学習用画像データセット、学習用座標データセットのパスを指定し、任意の試験名を指定して実行してください。

　以下のファイルが生成されます。

　同じフォルダ内　plotmodel_試験名.png

　weightsフォルダ内

- モデルファイル（学習結果）　model_試験名.hdf5
- 学習履歴　histry_試験名.csv


### 予測用データセットの作成

　loincenter_makedata_for_predict.py に、ロース芯中央を予測する画像を入れたフォルダ名、および出力する画像データセット名と画像リストのファイル名を指定して実行してください。

　
### ロース芯中心座標の予測

　loincenter_predict.py に、任意の試験名を指定し、学習済みモデルファイルのパスを指定して実行してください。

　学習済みモデルは、上の学習で出力された model_ooooo.hdf5 ファイルです。

　weightsフォルダ内に、pred_試験名.csvファイルとして予測結果が出力されます。

### ロース芯画像の切り出し

　画像リストのcsvファイルを作成しておいてください。
csvファイルの内容は「枝肉断面画像のファイル名」，「X座標の数値」，「Y座標の数値」を、img, center_x, center_y　のカラム名で入力してください。

　loin_crop_fromImg.py に、元画像（枝肉断面画像）を入れたフォルダのパスと、ロース芯画像の出力先フォルダのパス、および画像リストcsvファイルのパスを指定して実行してください。


## ロース芯画像のBMS予測

### データセットの作成

　画像リストのcsvファイルをあらかじめ作成しておきます。  
画像は一つのフォルダの中に入れ、あらかじめ、訓練群（train）か検証群（test）のどちらに振り分けるかを決定しておいてください。  

画像リストはcsvファイルで、
| img | BMS | year | class |
|-----|-----|------|-------|
|ロース芯画像のファイル名|BMSNo.|出荷年|群(train/test)|

の構成で作成してください。

画像リストのソート順は、後の予測値との照らし合わせの際に重要になりますので、順番を絶対に変えないか、ソート順を変更しても元に戻せるようにしてください。train/testごとに、画像ファイル名順でソートするような並びをお勧めします。

　BMS_makedata_for_train.py
に、画像リストcsvファイルのパスと、
ロース芯画像を入れたフォルダのパスを指定し、
出力ファイル名を変更する場合は変更して、
実行してください。

　訓練群と検証群それぞれ、
画像データセット、
出荷年データセット、
ラベル（BMS）データセットが出力されます。
 
### BMSの学習（出荷年データなし）)

　訓練群および検証群の、画像とラベルのデータセットのみを使います。

BMS_train.pyと同じ場所に、weightsフォルダを作ってください。出力結果が振り分けられます。
BMS_train.py内の、訓練群、検証群データセットのパスを指定してください。  
さらに、予測する画像データセットが別にある場合は、88行目に予測データセットのパスを指定してください。ない場合は、検証群データセットのパスを指定してください。
また、学習の試験名を任意で考えて指定してください。出力される結果には、全てこの試験名が付けられます。

BMS_train.py を実行すると、学習状況が１エポックごとに数値で表示されていきます。  
指定されたエポック数が終了すると、学習履歴のグラフ2枚が表示されます。  
このグラフ2枚を閉じると、スクリプトが終了します。

出力結果は、

- モデル図（plotmodel_試験名.png　BMS_train.pyと同じフォルダに出力）
- weightsフォルダ内
    - モデル（model_試験名.hdf5）：CNNの構造やウェイトのデータ
    - 学習履歴（histry_試験名.csv)
    - 予測値（pred_試験名.csv）

以上の4ファイルです。

予測値は11列、画像枚数分の行数のcsvファイルです。  
上から画像リスト順に、1行11項目が1画像の予測値になります。  
11項目は左からBMSNo.=2...右端BMSNo.=12に相当し、数値はその画像がそのBMSである確率を表します。確率の最も高いBMSが予測BMSNo.であるとします。




 






　
